---
marp: true
theme: gaia
_class: lead
paginate: true

backgroundColor: #fff
backgroundImage: url('https://marp.app/assets/hero-background.svg')
---

 ## マイクロサービス時代のワークフローシステム
  〜Netflix Conductorを例に〜

---
# 自己紹介
- 松下正嗣
	- Javaプログラマー/アーキテクト。クレディセゾン社で、ソフトウェア開発内製化に取り組んでいます。
	- 最初の仕事は研修講師->SIの現場へ。大学/大学院と文系でした。
---
# お話しする内容
- ちょっと国外で流行り出しているワークフローシステムの説明
- 現代的システムアーキテクチャについての1考察
- OSSプロダクトのデモ
- 試験運用は一部やってみた。


---
# ワークフローシステムとは？
"もともと1回限りのバッチパイプラインが継続的に結果を更新しなければならないというビジネス上の要求に対応しきれなくたってしまっている...
こうしたニーズに直面したに直面したGoogleは2003年にWorkflowというシステムを開発したました。これは継続的な処理を大規模に行えるようにしたものです。" 

『SRE サイトリラアビリティエンジニアリング』
25章 データ処理のパイプライン

---
# ワークフローシステムとは？
- タスクを実行するワーカーとそれを制御するコントローラ
- スケーラブル(worker/controllerともに)
- 冪等でシンプルなタスクをworkerが実行し、controllerが制御する
  - 人のタスクも組み込むことも可能。

<div style="text-align: center">
<img src = "workflow.drawio.svg" width="300px"/>
</div>

---
# 海外でのプロダクトの誕生
- [Temporal](https://temporal.io/)
  - Uberで開発された[Cadence](https://github.com/uber/cadence)をforkしてビジネス化
  - TemporalのCTOはuberの前はAWSのStep Functionの全身AWS Flowのエンジニア
  - Thoutworks Tech Radarでも言及
- [Conductor](https://conductor-oss.org/)
  - Netflixで開発されたデータパイプラインOSS。独立して[orkes.io](https://orkes.io/)としてビジネス化。
  - Conductorをベースにしたデータ処理基盤maestroをNetflixが最近公開


---
# 求められる背景
- ジョブスケジューラでは対応できない、長期/短期の継続的データ更新パイプラインの必要性
- スケーラビリティ/レイテンシーの必要性
- 分散システムの複雑化/マイクロサービス化/疎結合化→オーケストレーションが必要に
  - 処理が分散されたフロー全体の整合性の確保とリトライや例外処理/サーガパターン
  - 後述
- 自動テストとCI/CDへの対応


---

# 代替サービス?
- バッチ処理と呼ばれる長期/スケジュールタスク
  - ジョブスケジューラ(cron/商用スケジューラ/Apache Aireflow/その他)
  - ジョブ実行サービスを立てることで準オンラインに対応している場合も多いが、ジョブネット/フローがスケジューラ管理。
- 主にシステム間連携に利用されるメッセージキューシステム/オンライン非同期
  - メッセージングシステム/ストリーミングシステム(IBM MQ/Rabbit MQ/Kafka)
  - リトライや結果整合性は担保できるがフロー全体の管理とデータ整合性確保は課題。DBなどで頑張ることになる。

---

# マイクロサービスにおけるオーケストレーションの課題
- どこまで細かくするかは別の課題としてあるが、結果整合性/分散処理モデルがより一般的に。システム間ではなくシステム内でも非同期分散処理が一般的になってきている。
- トランザクション管理の課題
 - 複数サービス間の整合性をどうやって確保するのか、

--- 

# 製品比較
- Temporal
  - uberの注文のようなシステムと人のタスクが組み合わさった複雑な長期タスクに向いている
  - 全体フローもコードで管理。ちとワークフローのバージョン管理が未成熟。バージョンを意識したロジックをワークフロー上に記載する必要がある
  - goで書かれている。

- conductor
  - Netflixのデータパイプライン用のOSS。ポーリングによるタスク実行なので、リアルタイム性はTemporalより落ちる。ワークフローがjsonベースで視覚化しやすい
  - Spring Bootで書かれている


--- 
# 参考記事
[Temporalというマイクロサービスオーケストレーションについて](https://cloudandbuild.jp/blog/article-20220508)
[SRE サイトリライアビリティエンジニアリング](https://amzn.asia/d/8LPfFDk)





